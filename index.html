<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title id="web-title">灵感矩阵 | 设计作品集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Helvetica Now Display', 'Helvetica Neue', 'Arial', sans-serif;
            overflow: hidden;
            background: #000;
            user-select: none;
            min-height: 100vh;
        }
        #grid-container {
            width: 140vw;
            height: 140vh;
            position: absolute;
            inset: 0;
            margin: auto;
            display: grid;
            transform-style: preserve-3d;
        }
        .grid-item {
            transition: transform .15s cubic-bezier(.4,0,.2,1), opacity .15s, filter .15s;
            will-change: transform, opacity, filter;
            opacity: .7;
        }
        .table-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #4B5563;
        }
        .admin-table-row:hover {
            background-color: #374151;
        }
        .selected-row {
            background-color: #EF4444 !important;
        }
    </style>
</head>
<body class="text-white overflow-hidden">

<!-- 顶部内容 -->
<div id="top-content-area" class="fixed top-0 left-0 right-0 p-8 md:p-12 z-20 pointer-events-none">
    <div id="admin-persistent-controls" class="absolute top-8 right-8 z-30 flex space-x-4 pointer-events-auto">
        <button id="view-toggle-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition hidden" onclick="switchView(currentView==='grid'?'table':'grid')">切换到列表编辑</button>
    </div>
    <div id="content-display" class="flex flex-col pointer-events-auto">
        <h1 id="main-title" class="text-4xl md:text-8xl font-extrabold cursor-text transition-colors hover:text-yellow-400">3D&Motion Creative&Production</h1>
        <p id="sub-text" class="text-base md:text-2xl text-gray-400 cursor-text transition-colors hover:text-gray-200">Powered by REDesign</p>
    </div>
</div>

<!-- 管理员表格视图 -->
<div id="admin-table-view" class="fixed inset-0 p-4 md:p-12 z-10 hidden overflow-auto pointer-events-auto">
    <h1 class="text-3xl font-bold mb-4 text-red-400">网格素材列表编辑（共 60 项）</h1>
    <div id="admin-table-container"></div>
</div>

<!-- 版权/管理员触发 -->
<div id="admin-toggle-btn" class="fixed bottom-4 right-4 z-50 text-gray-400 text-sm font-medium pointer-events-auto cursor-default">
    2025 <span class="cursor-pointer hover:text-white" onclick="handleAdminToggle()">©</span> All Rights Reserved By REDesign
</div>

<!-- 网格容器 -->
<div id="grid-container"></div>

<!-- 视频模态框 -->
<div id="video-modal" class="fixed inset-0 bg-black/90 z-50 flex justify-center items-center hidden">
    <div class="relative w-full max-w-4xl aspect-video rounded-xl overflow-hidden">
        <video id="video-player" class="w-full h-full object-cover" controls autoplay playsinline></video>
        <button id="close-modal" class="absolute top-4 right-4 text-white p-2 rounded-full bg-black/50 hover:bg-black/80" onclick="closeVideoModal()">✕</button>
    </div>
</div>

<!-- Firebase 与业务脚本 -->
<script type="module">
/* ==================  Firebase 初始化  ================== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
import { getFirestore, doc, updateDoc, collection, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyDApuOEfnj7x7lg7T-3xceKQMlRvcdJV68",
    authDomain: "design-c9479.firebaseapp.com",
    projectId: "design-c9479",
    storageBucket: "design-c9479.firebasestorage.app",
    messagingSenderId: "779638854632",
    appId: "1:779638854632:web:cd467e5c88cb87c2de0a5d"
};
const appId = 'design-c9479';
const PLACEHOLDER_VID = "https://www.w3schools.com/html/mov_bbb.mp4";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await signInAnonymously(auth);

/* ==================  全局变量  ================== */
const TOTAL_ITEMS = 60;
const GRID_COLS = 10;
const GRID_ROWS = 6;
let currentView = 'grid';
let isAdminMode = false;
let itemData = {};                      // 本地缓存
let items = [];                         // DOM 元素缓存
let mousePos = { x: 0, y: 0 };
let isMouseActive = false;
let animationFrameId = null;
let parallaxOffset = { x: 0, y: 0 };
let selectedItemId = null;
let isFocusMode = false;

const CENTER_DISTANCE_MAP = (() => {
    const map = [];
    const C_TARGET = 4, R_TARGET = 2;
    for (let i = 0; i < TOTAL_ITEMS; i++) {
        const C = i % GRID_COLS, R = Math.floor(i / GRID_COLS);
        map.push({ originalIndex: i, distance: (C_TARGET - C) ** 2 + (R_TARGET - R) ** 2 });
    }
    map.sort((a, b) => a.distance - b.distance || a.originalIndex - b.originalIndex);
    const newIdToOriginalIndex = map.map(it => it.originalIndex);
    const originalIndexToNewId = Array(TOTAL_ITEMS).fill(0);
    newIdToOriginalIndex.forEach((orig, nid) => originalIndexToNewId[orig] = nid);
    return { newIdToOriginalIndex, originalIndexToNewId };
})();

/* ==================  管理员保存修复  ================== */
window.saveInlineItemChange = async (itemId, imgInputId, vidInputId, btn) => {
    const img = document.getElementById(imgInputId).value.trim();
    const vid = document.getElementById(vidInputId).value.trim();

    if (img && !isValidURL(img)) { alert('图片URL格式无效'); return; }
    if (vid && !isValidURL(vid)) { alert('视频URL格式无效'); return; }

    btn.disabled = true;
    btn.textContent = '保存中...';
    btn.className = 'px-3 py-1 bg-gray-500 text-white font-semibold rounded-lg';

    const payload = { img: img || null, vid: vid || PLACEHOLDER_VID };
    const colPath = `artifacts/${appId}/public/data/grid_items`;
    const docRef = doc(db, colPath, itemId);

    try {
        await updateDoc(docRef, payload);
        btn.textContent = '已保存';
        btn.className = 'px-3 py-1 bg-green-600 text-white font-semibold rounded-lg';
        setTimeout(() => { btn.textContent = '保存'; btn.disabled = false; btn.className = 'px-3 py-1 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700'; }, 2000);
    } catch (err) {
        console.error('保存失败', err);
        btn.textContent = '保存失败';
        btn.className = 'px-3 py-1 bg-red-600 text-white font-semibold rounded-lg';
        setTimeout(() => { btn.textContent = '保存'; btn.disabled = false; btn.className = 'px-3 py-1 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700'; }, 4000);
    }
};

function isValidURL(str) {
    try { const u = new URL(str); return u.protocol === 'http:' || u.protocol === 'https:'; } catch { return false; }
}

/* ==================  渲染管理员表格  ================== */
function renderAdminTable() {
    const host = document.getElementById('admin-table-container');
    if (!host) return;
    let html = `<div class="overflow-x-auto h-[80vh] bg-gray-900/90 backdrop-blur-sm rounded-xl shadow-2xl p-4">
        <table class="min-w-full divide-y divide-gray-700"><thead class="sticky top-0 bg-gray-900/95">
        <tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase w-16">ID</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase w-20">预览</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase w-24">位置</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-300">图片 URL</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-300">视频 URL</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 w-24">操作</th></tr></thead><tbody class="divide-y divide-gray-800">`;
    for (let newId = 0; newId < TOTAL_ITEMS; newId++) {
        const origIdx = CENTER_DISTANCE_MAP.newIdToOriginalIndex[newId];
        const itemId = `item_${origIdx}`;
        const dat = itemData[itemId] || {};
        const img = dat.img || '';
        const vid = dat.vid || PLACEHOLDER_VID;
        const preview = img || `https://placehold.co/60x60/374151/FFFFFF?text=${origIdx}`;
        html += `<tr id="row-${itemId}" class="admin-table-row text-gray-300 cursor-pointer" data-item-id="${itemId}" onclick="selectItem('${itemId}',this)">
          <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">${newId}</td>
          <td class="px-3 py-2 whitespace-nowrap"><img src="${preview}" class="table-thumbnail" onerror="this.src='https://placehold.co/60x60/374151/FFFFFF?text=${origIdx}'"></td>
          <td class="px-3 py-2">${renderLocationThumbnail(origIdx, dat.bgColor || '#374151')}</td>
          <td class="px-3 py-2 text-sm max-w-sm"><input id="img-input-${itemId}" type="text" value="${img}" placeholder="Image URL" class="w-full text-xs rounded-md bg-gray-700 border-gray-600 text-white p-1 focus:ring-red-500 focus:border-red-500"></td>
          <td class="px-3 py-2 text-sm max-w-sm"><input id="vid-input-${itemId}" type="text" value="${vid}" placeholder="Video URL" class="w-full text-xs rounded-md bg-gray-700 border-gray-600 text-white p-1 focus:ring-red-500 focus:border-red-500"></td>
          <td class="px-3 py-2 whitespace-nowrap text-sm"><button class="px-3 py-1 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition" onclick="event.stopPropagation(); saveInlineItemChange('${itemId}', 'img-input-${itemId}', 'vid-input-${itemId}', this);">保存</button></td>
        </tr>`;
    }
    html += '</tbody></table></div>';
    host.innerHTML = html;
}

function renderLocationThumbnail(index, highlightColor) {
    let gridHtml = `<div class="w-[60px] h-[45px] grid gap-[1px] bg-gray-900 border border-gray-700 rounded-sm overflow-hidden" style="grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(6, 1fr);">`;
    for (let i = 0; i < TOTAL_ITEMS; i++) {
        gridHtml += `<div class="w-full h-full" style="background-color: ${i === index ? highlightColor : '#374151'};"></div>`;
    }
    gridHtml += '</div>';
    return gridHtml;
}

/* ==================  视图 / 管理员开关  ================== */
window.switchView = v => {
    currentView = v;
    const grid = document.getElementById('grid-container');
    const table = document.getElementById('admin-table-view');
    const btn = document.getElementById('view-toggle-btn');
    if (v === 'table') {
        grid.classList.add('hidden');
        table.classList.remove('hidden');
        renderAdminTable();
        btn.textContent = '返回网格视图';
    } else {
        grid.classList.remove('hidden');
        table.classList.add('hidden');
        btn.textContent = '切换到列表编辑';
    }
};

window.setAdminMode = on => {
    isAdminMode = on;
    document.getElementById('view-toggle-btn').classList.toggle('hidden', !on);
    if (on) window.switchView('grid');
};

window.handleAdminToggle = () => {
    if (isAdminMode) window.setAdminMode(false);
    else {
        const pw = prompt('密码：');
        if (pw === '1234') window.setAdminMode(true);
    }
};

/* ==================  网格交互  ================== */
const GRID_COLORS = ['#EF4444','#F97316','#F59E0B','#10B981','#3B82F6','#6366F1','#8B5CF6','#EC4899','#FBBF24','#A78BFA','#4ADE80','#FB7185','#D946EF','#06B6D4'];

function createGrid() {
    const container = document.getElementById('grid-container');
    container.innerHTML = '';
    container.style.gridTemplateColumns = `repeat(${GRID_COLS}, 1fr)`;
    for (let i = 0; i < TOTAL_ITEMS; i++) {
        const itemId = `item_${i}`;
        const color = GRID_COLORS[i % GRID_COLS];
        const div = document.createElement('div');
        div.className = 'grid-item aspect-square bg-cover bg-center cursor-pointer';
        div.dataset.videoId = itemId;
        div.style.backgroundColor = color;
        div.style.transform = 'scale(0.175)';
        div.style.opacity = '0.7';
        container.appendChild(div);
        items.push({ el: div, center: { x: 0, y: 0 } });
    }
    cacheItemPositions();
}

function cacheItemPositions() {
    const old = document.getElementById('grid-container').style.transform;
    document.getElementById('grid-container').style.transform = '';
    items.forEach(it => {
        const r = it.el.getBoundingClientRect();
        it.center = { x: r.left + r.width / 2, y: r.top + r.height / 2 };
    });
    document.getElementById('grid-container').style.transform = old;
}

/* 监听数据 → 更新本地缓存 → 重渲染表格 */
onSnapshot(collection(db, `artifacts/${appId}/public/data/grid_items`), snap => {
    snap.docChanges().forEach(chg => {
        const id = chg.doc.id;
        if (!id.startsWith('item_')) return;
        itemData[id] = chg.doc.data();
    });
    if (currentView === 'table') renderAdminTable();
});

/* 鼠标鱼眼 + 视差 */
let parallaxOffset = { x: 0, y: 0 };
function updateFisheye() {
    const vx = window.innerWidth / 2, vy = window.innerHeight / 2;
    if (!isFocusMode) {
        parallaxOffset.x += ((mousePos.x - vx) * 0.1 - parallaxOffset.x) * 0.2;
        parallaxOffset.y += ((mousePos.y - vy) * 0.1 - parallaxOffset.y) * 0.2;
    } else {
        const it = items.find(i => i.el.dataset.videoId === selectedItemId);
        if (it) {
            parallaxOffset.x += (vx - it.center.x - parallaxOffset.x) * 0.05;
            parallaxOffset.y += (vy - it.center.y - parallaxOffset.y) * 0.05;
        }
    }
    document.getElementById('grid-container').style.transform = `translate3d(${parallaxOffset.x}px, ${parallaxOffset.y}px, 0)`;

    if (isAdminMode && currentView === 'table') { animationFrameId = requestAnimationFrame(updateFisheye); return; }
    if (isAdminMode) { animationFrameId = requestAnimationFrame(updateFisheye); return; }

    /* 鱼眼缩放 */
    const fx = mousePos.x, fy = mousePos.y, r = 300, min = 0.175, max = 3, pow = 2;
    items.forEach(it => {
        const dx = fx - (it.center.x + parallaxOffset.x);
        const dy = fy - (it.center.y + parallaxOffset.y);
        const dist = Math.hypot(dx, dy);
        let scale = min, opacity = 0.7;
        if (dist < r) {
            const p = 1 - dist / r;
            scale = min + (max - min) * (1 - Math.pow(1 - p, pow));
            opacity = 0.7 + 0.3 * p;
        }
        it.el.style.transform = `scale(${scale})`;
        it.el.style.opacity = opacity;
    });
    if (isMouseActive) animationFrameId = requestAnimationFrame(updateFisheye);
}

window.addEventListener('mousemove', e => {
    mousePos.x = e.clientX; mousePos.y = e.clientY;
    if (!isMouseActive) { isMouseActive = true; updateFisheye(); }
});
window.addEventListener('mouseleave', () => { isMouseActive = false; });

/* 点击网格项 */
document.getElementById('grid-container').addEventListener('click', e => {
    const item = e.target.closest('.grid-item');
    if (!item) return;
    const id = item.dataset.videoId;
    if (isAdminMode) {
        window.switchView('table');
        const row = document.getElementById(`row-${id}`);
        if (row) { window.selectItem(id, row); row.scrollIntoView({ block: 'center', behavior: 'smooth' }); }
        return;
    }
    openVideoModal(itemData[id]?.vid || PLACEHOLDER_VID);
});

function openVideoModal(src) {
    const modal = document.getElementById('video-modal');
    const player = document.getElementById('video-player');
    player.src = src;
    modal.classList.remove('hidden');
    player.play().catch(() => {});
}
function closeVideoModal() {
    const modal = document.getElementById('video-modal');
    const player = document.getElementById('video-player');
    modal.classList.add('hidden');
    player.pause();
    player.src = '';
    resetFocus();
}
function resetFocus() {
    isFocusMode = false;
    selectedItemId = null;
    document.querySelectorAll('.admin-table-row').forEach(r => r.classList.remove('selected-row'));
}

/* 首次渲染 */
window.addEventListener('DOMContentLoaded', () => {
    createGrid();
    renderAdminTable();
    updateFisheye();
});
</script>
</body>
</html>
